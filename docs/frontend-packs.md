# Frontend Review Packs

This document describes the output generated by the **Frontend Review Packs** stage of the credit-analyzer pipeline. The stage prepares JSON packs for the browser-based review tooling and publishes a manifest that the API and UI consume.

## Directory layout

For every run (identified by `sid`) the stage writes files under `runs/<sid>/frontend/review/`:

```
runs/<sid>/
  frontend/
    review/
      packs/
        idx-001.json
        idx-004.json
        ...
      responses/
      index.json
```

Key points:

- **No `frontend/accounts/**` directories are created**. All consumable artifacts live below `frontend/review/`.
- Each account pack is a standalone JSON document named `<account_id>.json` inside `frontend/review/packs/` (for example `idx-016.json`).
- Any follow-up reviewer responses should be stored inside `frontend/review/responses/` (mirroring the pack name when possible).

## Manifest schema

The manifest is written to `frontend/review/index.json`. It is a JSON object with two top-level keys:

```json
{
  "generated_at": "2024-04-18T22:41:15Z",
  "packs": [
    {
      "account_id": "idx-016",
      "path": "frontend/review/packs/idx-016.json"
    },
    {
      "account_id": "idx-023",
      "path": "frontend/review/packs/idx-023.json"
    }
  ]
}
```

- `generated_at` is an ISO-8601 timestamp (UTC) indicating when the manifest was produced.
- `packs` is an array sorted by `account_id`. Each entry provides the relative path that the frontend should load. Paths **must** be relative to the run root and live under the `frontend/review/` namespace.

## Pack schema

Each pack preserves the shape that downstream reviewers already consume:

```json
{
  "account_id": "idx-016",
  "holder_name": "Parker Lang",
  "primary_issue": "Reported fraud",
  "display": {
    "equifax": {
      "summary": "...",
      "details": ["..."]
    },
    "experian": {
      "summary": "...",
      "details": ["..."]
    },
    "transunion": {
      "summary": "...",
      "details": ["..."]
    }
  }
}
```

Fields that were historically present (`holder_name`, `primary_issue`, and the `display.*` per-bureau sections) remain unchanged. Additional metadata can be appended as needed provided the base schema remains backward compatible.

## API endpoints

The API/UI layers load artifacts directly from the `frontend/review/` namespace:

- `GET /runs/<sid>/frontend/review/index.json` — fetches the manifest.
- `GET /runs/<sid>/frontend/review/packs/<account_id>.json` — fetches an individual pack referenced in the manifest.
- `GET /runs/<sid>/frontend/review/responses/<account_id>.json` — retrieves reviewer-submitted feedback for a pack (optional).

Any previous references to `frontend/accounts/` should be updated to these new paths.

## Logging events

The stage emits a small, consistent set of structured logs:

- `frontend_review_start` — emitted when pack generation begins.
- `frontend_review_pack_created` — emitted once per account when a pack is written. Include `account_id` and the relative `path` in the log payload.
- `frontend_review_finish` — emitted when all packs are generated. Include counts and durations when available.
- `frontend_review_no_candidates` — emitted instead of `frontend_review_finish` if no accounts qualify for review.

No other `pack_skip` or ancillary events should be produced in this stage.

## Migration guidance

- Existing consumers must switch to loading `frontend/review/index.json` and the pack paths listed there. The previous `frontend/accounts/` namespace is deprecated and will no longer be populated.
- If older dashboards still expect `frontend/index.json`, optionally write a redirect file at `frontend/index.json` that contains:

  ```json
  {
    "redirect": "frontend/review/index.json"
  }
  ```

  The redirect is temporary and should be removed once all clients depend on the new manifest.

- Validate any infrastructure-as-code or deployment scripts to ensure they capture the new directory tree when archiving artifacts.

## Examples

Assuming a run `sid = 2024-04-18-abc123`, a minimal set of output files looks like:

```
runs/2024-04-18-abc123/frontend/review/index.json
runs/2024-04-18-abc123/frontend/review/packs/idx-016.json
runs/2024-04-18-abc123/frontend/review/packs/idx-023.json
```

With corresponding logs:

```
[info] frontend_review_start sid=2024-04-18-abc123
[info] frontend_review_pack_created sid=2024-04-18-abc123 account_id=idx-016 path=frontend/review/packs/idx-016.json
[info] frontend_review_pack_created sid=2024-04-18-abc123 account_id=idx-023 path=frontend/review/packs/idx-023.json
[info] frontend_review_finish sid=2024-04-18-abc123 pack_count=2
```

This structure is now canonical for the Frontend Review Packs stage.
